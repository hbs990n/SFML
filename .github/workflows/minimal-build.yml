name: SFML PowerShell Build

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-2025
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build with PowerShell (Correct Syntax)
      shell: pwsh  # 指定使用PowerShell
      run: |
        Write-Host "=== 开始编译 SFML ===" -ForegroundColor Green
        
        # 检查目录
        Write-Host "检查目录结构..." -ForegroundColor Yellow
        Get-ChildItem -Path "include" -Recurse -Depth 1 | Select-Object Name, FullName
        
        # 检查头文件是否存在
        $systemHeader = "include/SFML/System.hpp"
        if (Test-Path $systemHeader) {
          Write-Host "✓ 找到头文件: $systemHeader" -ForegroundColor Green
        } else {
          Write-Host "✗ 未找到头文件: $systemHeader" -ForegroundColor Red
          exit 1
        }
        
        # 进入System源码目录
        Set-Location "src/SFML/System"
        
        # 编译测试文件
        Write-Host "编译Clock.cpp..." -ForegroundColor Yellow
        & "C:\Program Files\Git\usr\bin\g++.exe" -c -I"../../../include" -DSFML_STATIC Clock.cpp
        
        # 检查是否成功
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✓ Clock.cpp 编译成功" -ForegroundColor Green
          
          # 创建库
          if (Test-Path "Clock.o") {
            & "C:\Program Files\Git\usr\bin\ar.exe" rcs libsfml-system.a Clock.o
            Write-Host "✓ 创建库文件" -ForegroundColor Green
          }
        }
        
        # 返回根目录
        Set-Location "../../../"
        
    - name: Create Output
      shell: pwsh
      run: |
        # 创建输出目录
        New-Item -ItemType Directory -Path "output" -Force
        New-Item -ItemType Directory -Path "output/include" -Force
        New-Item -ItemType Directory -Path "output/lib" -Force
        
        # 复制头文件
        if (Test-Path "include/SFML") {
          Copy-Item -Path "include/SFML" -Destination "output/include/" -Recurse
          Write-Host "✓ 头文件已复制" -ForegroundColor Green
        }
        
        # 复制库文件
        $libFile = "src/SFML/System/libsfml-system.a"
        if (Test-Path $libFile) {
          Copy-Item -Path $libFile -Destination "output/lib/"
          Write-Host "✓ 库文件已复制" -ForegroundColor Green
        }
        
        # 显示结果
        Write-Host "输出目录内容:" -ForegroundColor Cyan
        Get-ChildItem -Path "output" -Recurse
        
        # 创建ZIP
        Compress-Archive -Path "output/*" -DestinationPath "sfml-test.zip"
        
    - uses: actions/upload-artifact@v4
      with:
        name: SFML-Test-Build
        path: sfml-test.zip
